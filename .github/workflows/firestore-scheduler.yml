name: Update Firestore Bookings

on:
  schedule:
    - cron: '*/2 * * * *'  # Runs every 2 minutes
  workflow_dispatch:

jobs:
  update-bookings:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Skip job if between 10PM–5AM IST
        id: time-check
        run: |
          current_hour=$(date -u +"%H")
          current_minute=$(date -u +"%M")
          total_minutes=$((10#$current_hour * 60 + 10#$current_minute))

          echo "Current UTC time is $current_hour:$current_minute"

          # 10PM IST = 16:30 UTC (990 mins), 5AM IST = 23:30 UTC (1410 mins)
          if [ "$total_minutes" -ge 990 ] && [ "$total_minutes" -lt 1410 ]; then
            echo "In the blocked window (10PM–5AM IST). Skipping."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "Outside blocked window. Proceeding."
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install dependencies
        if: ${{ steps.time-check.outputs.skip == 'false' }}
        run: npm install

      - name: Run Firestore Update Script
        if: ${{ steps.time-check.outputs.skip == 'false' }}
        run: node updateBookings.js
        env:
          FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}
